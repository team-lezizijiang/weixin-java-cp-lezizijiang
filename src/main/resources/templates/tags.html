<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <title>标签群</title>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">
    <link rel="stylesheet" th:href="@{https://res.wx.qq.com/open/libs/weui/1.1.2/weui-for-work.css}">
</head>
<body class="weui-page">
<h1 class="page__title" th:id='userName' th:text="${username}" th:name="${username}"></h1>
<hr class="layui-bg-blue">
<form class="weui-form">
    <div class="weui-form__control-area">
        <div class="weui-cells__group weui-cells__group_form">
            <div class="weui-cells weui-cells_checkbox" id="tagList">
                <label class="weui-cell weui-cell_active weui-check__label" th:each="tag : ${AllTags}"
                       th:for="${#ids.next('tag')}">
                    <div class="weui-cell__hd">
                        <input class="weui-check" th:checked="${tag.isChecked}" th:id="${#ids.seq('tag')}" th:name="Tag" th:value="${tag.author}"
                               type="checkbox"/>
                        <i class="weui-icon-checked"></i>
                    </div>
                    <div class="weui-cell__bd">
                        <p th:text="${tag.author}"></p>
                    </div>
                </label>
            </div>
        </div>
    </div>
    <div class="weui-form__opr-area">
        <a href="javascript:" class="weui-btn weui-btn_primary" id="commit">提交 </a>
        <a href="javascript:" class="weui-btn weui-btn_primary" onclick=""> 重置 </a>
    </div>
</form>
<div id="toast" style="display: none;">
    <div class="weui-mask_transparent"></div>
    <div class="weui-toast">
        <i class="weui-icon-success-no-circle weui-icon_toast"></i>
        <p class="weui-toast__content">已成功订阅</p>
    </div>
</div>

<div id="warnToast" style="display: none;">
    <div class="weui-mask_transparent"></div>
    <div class="weui-toast">
        <i class="weui-icon-warn weui-icon_toast"></i>
        <p class="weui-toast__content">订阅失败</p>
    </div>
</div>
</body>
<script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js">
    $(function(){
        var userName = document.getElementById('userName');
        var box = document.getElementsByName("Tag");
        var len = box.length;
        var apiContentStr = [] ;
        var $warnToast = $('#warnToast');
        $('#commit').on('click', function (){
            apiContentStr.push(userName.innerText)
            for (var i = 0; i < len; i++) {
                if (box[i].checked === true) {
                    apiContentStr.push(box[i].value);
                }
            }
            if (apiContentStr.length === 1) {
                return;
            }
            var httpRequest = new XMLHttpRequest();//第一步：创建需要的对象
            httpRequest.open('POST', 'https://message.lezizijiang.cn/subscribe', true); //第二步：打开连接
            httpRequest.setRequestHeader("Content-type", "application/json");
            httpRequest.send(JSON.stringify(apiContentStr));
            httpRequest.onreadystatechange = function () {//请求后的回调接口，可将请求成功后要执行的程序写在其中
                if (httpRequest.readyState === 4 && httpRequest.status === 200) {//验证请求是否发送成功
                    var json = httpRequest.responseText;//获取到服务端返回的数据`
                    if ($toast.css('display') !== 'none') return;
                    $toast.fadeIn(100);
                    setTimeout(function () {
                        $toast.fadeOut(100);
                    }, 2000);
                    console.log(json);
                }else{
                    if ($warnToast.css('display') != 'none') return;
                    $warnToast.fadeIn(100);
                    setTimeout(function () {
                        $warnToast.fadeOut(100);
                    }, 2000);
                    console.log("callback失败");
                }
            };
        });
    });
</script>
</html>

