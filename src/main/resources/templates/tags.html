<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>标签群</title>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">
    <link rel="stylesheet" th:href="@{/layui/css/layui.mobile.css}">
    <link rel="stylesheet" th:href="@{https://res.wx.qq.com/open/libs/weui/1.1.2/weui-for-work.css}">
</head>
<body class="weui-page">
<h1 class="page__title" th:id='userName' th:text="'Hello, ' + ${username} + '!'"></h1>
<hr class="layui-bg-blue">
<form class="weui-form">
    <div class="weui-form__control-area">
        <div class="weui-cells__group weui-cells__group_form">
            <div class="weui-cells weui-cells_checkbox">
                <label class="weui-cell weui-cell_active weui-check__label" id="tagList" th:each="tag : ${AllTags}"
                       th:for="${#ids.next('tag')}">
                    <div class="weui-cell__hd">
                        <input class="weui-check" th:checked="${tag.isChecked}" th:id="${#ids.seq('tag')}" th:name="Tag"
                               type="checkbox"/>
                        <i class="weui-icon-checked"></i>
                    </div>
                    <div class="weui-cell__bd">
                        <p th:text="${tag.author}"></p>
                    </div>
                </label>
            </div>
        </div>
    </div>
    <div class="weui-form__opr-area">
        <a class="weui-btn weui-btn_primary" href="javascript:" id="showTooltips"></a>
        <input class="b_button" onclick="nextStep()" type="submit" value="提交"/>
        <input class="b_button" type="reset" value="重置"/>
    </div>
    <div class="pageRow">
        <div id="pageination"></div>
    </div>
    <!--    <div class="weui-form__tips-area">-->
    <!--        <p class="weui-form__tips">-->
    <!--            点击下一步即表示<a href="javascript:">同意用户协议</a>-->
    <!--        </p>-->
    <!--    </div>-->
</form>
<!--<div id="js_toast" style="display: none;">-->
<!--    <div class="weui-mask_transparent"></div>-->
<!--    <div class="weui-toast">-->
<!--        <i class="weui-icon-success-no-circle weui-icon_toast"></i>-->
<!--        <p class="weui-toast__content">已完成</p>-->
<!--    </div>-->
<!--</div>-->
</body>
<script type="text/javascript">
    $(function () {
        var $tooltips = $('.js_tooltips');
        var $toast = $('#js_toast');

        $('#showTooltips').on('click', function () {
            // toptips的fixed, 如果有`animation`, `position: fixed`不生效
            $('.page.cell').removeClass('slideIn');

            $toast.fadeIn(100);
            setTimeout(function () {
                $toast.fadeOut(100);
            }, 2000);
        });
    });

    function nextStep() {
        var userName = document.getElementById("userName");
        var box = document.getElementsByName("Tag");
        var len = box.length;
        var apiContentStr = userName + ",";

        for (var i = 0; i < len; i++) {
            if (box[i].checked === true) {
                apiContentStr += box[i].value + ",";
            }
        }
        if (apiContentStr === userName + "," || apiContentStr.length === userName.length + 1) {
            alert("请勾选需要的资源项!");
            return;
        }
        apiContentStr = apiContentStr.substring(0, apiContentStr.length - 1);
        var httpRequest = new XMLHttpRequest();//第一步：创建需要的对象
        httpRequest.open('POST', 'message.lezizijiang.cn/subscribe', true); //第二步：打开连接
        httpRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        httpRequest.send(apiContentStr);
        // todo 确认信息类型，增加注解
    }

    // 添加分页功能
    function pagination() {
        var tableData = document.getElementById("tagList");
        var totalCount = tableData.rows.length;  //总条数

        //设置表格总页数
        var totalPage = 0;//列表的总页数
        var pageSize = 8;
        //对数据进行分页
        var currentPage = 1;
        var startRow = (currentPage - 1) * pageSize + 1;
        var endRow = (currentPage * pageSize > totalCount ? totalCount : currentPage * pageSize);

        for (var i = 1; i < (totalCount + 1); i++) {
            var iRow = tableData.rows[i - 1];
            if (i >= startRow && i <= endRow) {
                iRow.style.display = "block";
            } else {
                iRow.style.display = "none";
            }
        }
        //位置2 生成当前的点击按钮
        createBtns(totalPage, currentPage);
        //位置3  绑定点击事件
        bindClick(totalPage);

    }

    //生成点击按钮
    //totalPages 分页的总页数
    //current当前页
    function createBtns(totalPages, current) {
        var tempStr = "";
        /*上一页按钮*/
        if (current > 1) {
            /* tempStr += "<span class='btn first' href=\"#\"  data-page = '1'>首页</span>";*/
            tempStr += "<span class='btn prev' href=\"#\" data-page = " + (current - 1) + ">上一页</span>"
        }
        /*中间页码的显示*/
        /*如果总页数超出5个处理办法*/
        if (totalPages <= 5) {
            for (var pageIndex = 1; pageIndex < totalPages + 1; pageIndex++) {
                tempStr += "<a  class='btn page" + pageIndex + "'  data-page = " + (pageIndex) + "><span>" + pageIndex + "</span></a>";
            }
        } else {
            if (current < 5) {
                for (var pageIndex = 1; pageIndex < 5; pageIndex++) {
                    tempStr += "<a  class='btn page" + pageIndex + "'  data-page = " + (pageIndex) + "><span>" + pageIndex + "</span></a>";
                }
                tempStr += '<span>......</span>';
                tempStr += "<a  class='btn page" + totalPages + "'  data-page = " + (totalPages) + "><span>" + totalPages + "</span></a>";
            } else if (current >= totalPages - 4) {
                tempStr += "<a  class='btn page" + 1 + "'  data-page = " + (1) + "><span>" + 1 + "</span></a>";
                tempStr += '<span>......</span>';
                for (var pageIndex = totalPages - 4; pageIndex <= totalPages; pageIndex++) {
                    tempStr += "<a  class='btn page" + pageIndex + "'  data-page = " + (pageIndex) + "><span>" + pageIndex + "</span></a>";
                }
            } else if (current >= 5 && current < totalPages - 4) {
                tempStr += "<a  class='btn page" + 1 + "'  data-page = " + (1) + "><span>" + 1 + "</span></a>";
                tempStr += '<span>......</span>';
                for (var pageIndex = current; pageIndex <= current + 4; pageIndex++) {
                    tempStr += "<a  class='btn page" + pageIndex + "'  data-page = " + (pageIndex) + "><span>" + pageIndex + "</span></a>";
                }
                tempStr += '<span>......</span>';
                tempStr += "<a  class='btn page" + totalPages + "'  data-page = " + (totalPages) + "><span>" + totalPages + "</span></a>";
            }
        }
        /*下一页按钮*/
        if (current < totalPages) {
            tempStr += "<span class='btn next' href=\"#\"  data-page = " + (current + 1) + ">下一页</span>";
            /*            tempStr += "<span class='btn last' href=\"#\" data-page = "+ (totalPages) +">尾页</span>";*/
        }
        document.getElementById("pageination").innerHTML = tempStr;
    }

    function bindClick(totalPage) {
        // 设置首页、末页、上一页、下一页的点击事件
        var buttonArr = ['first', 'last', 'prev', 'next'];
        for (var k in buttonArr) {
            var $dom = '.' + buttonArr[k];
            $('body').delegate($dom, 'click', function () {
                var data = $(this).data('page');//获取当前按钮跳转的页数
                pagination('3', data);//对页面进行分页
                //对当前页码的样式做处理
                $('.page' + data).css({background: '#0449d4', color: '#fff'}).siblings().css({
                    background: '#fff',
                    color: '#999'
                });
            })
        }

        // 设置数码的点击事件 totalImgPage是总页数，为全局变量，在分页时被赋值
        for (var k = 1; k <= totalPage; k++) {
            var $singleDom = '.page' + k;
            $('body').delegate($singleDom, 'click', function () {
                var data = $(this).data('page');
                pagination('3', data);//对页面进行分页
                //对当前页码的样式做处理
                $('.page' + data).css({background: '#0449d4', color: '#fff'}).siblings().css({
                    background: '#fff',
                    color: '#999'
                });
            })
        }
    }
</script>
</html>
